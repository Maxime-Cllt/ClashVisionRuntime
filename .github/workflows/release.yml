name: "Build & Release Workflow"

permissions:
  contents: write

on:
  push:
    branches: [ "main" , "master", "gha-release" ]
  workflow_dispatch:
    inputs:
      version:
        type: string
        description: "Version (e.g., v2024.12.25)"
        required: false
      publish:
        type: boolean
        description: "Publish release"
        default: true
      overwrite_tag:
        type: boolean
        description: "Overwrite tag if it exists"
        default: false
  workflow_call:
    inputs:
      version:
        type: string
        description: "Version (e.g., v2024.12.25)"
        required: false
      publish:
        type: boolean
        default: true
      overwrite_tag:
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always

jobs:
  validate-input:
    runs-on: ubuntu-latest
    outputs:
      is_valid: ${{ steps.validate.outputs.is_valid }}
    steps:
      - name: Validate version format
        id: validate
        run: |
          if [[ "${{ github.event.inputs.version }}" =~ ^v[0-9]{4}\.[0-9]{2}\.[0-9]{2}(-[0-9]+)?$ ]] || [[ "${{ github.event_name }}" == "push" ]] || [[ -z "${{ github.event.inputs.version }}" ]]; then
            echo "is_valid=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_valid=false" >> "$GITHUB_OUTPUT"
            echo "::error::Invalid version format. Expected: vYYYY.MM.DD or vYYYY.MM.DD-N"
            exit 1
          fi

  determine-version:
    needs: validate-input
    runs-on: ubuntu-latest
    outputs:
      tag_version: ${{ steps.version.outputs.tag_version }}
      crate_version: ${{ steps.version.outputs.crate_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # Auto-generate version for push events
            current_date=$(date +"%Y.%m.%d")
            base_tag="v${current_date}"
          
            # Find existing tags for today and determine next increment
            existing_tags=$(git tag -l "${base_tag}*" | sort -V)
          
            if [[ -z "$existing_tags" ]]; then
              new_tag="$base_tag"
            else
              # Extract highest increment
              highest_increment=$(echo "$existing_tags" | sed "s/${base_tag}//" | sed 's/^-//' | grep -E '^[0-9]*$' | sort -n | tail -n1)
              if [[ -z "$highest_increment" || "$highest_increment" == "" ]]; then
                new_increment=1
              else
                new_increment=$((highest_increment + 1))
              fi
              new_tag="${base_tag}-${new_increment}"
            fi
          elif [[ -n "${{ inputs.version }}" ]]; then
            # Use provided version
            new_tag="${{ inputs.version }}"
          else
            # Generate date-based version for manual dispatch without version
            current_date=$(date +"%Y.%m.%d")
            new_tag="v${current_date}"
          fi
          
          crate_version=$(echo "$new_tag" | sed 's/^v//')
          
          echo "tag_version=$new_tag" >> "$GITHUB_OUTPUT"
          echo "crate_version=$crate_version" >> "$GITHUB_OUTPUT"
          
          echo "::notice::Generated version: $new_tag (crate: $crate_version)"

      - name: Update Cargo.toml version
        if: github.event_name != 'push'
        run: |
          version="${{ steps.version.outputs.crate_version }}"
          sed -i "s/^version = \".*\"/version = \"$version\"/" Cargo.toml
          echo "::notice::Updated Cargo.toml version to: $version"

  create-tag:
    needs: [validate-input, determine-version]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Handle existing tag
        run: |
          tag="${{ needs.determine-version.outputs.tag_version }}"
          
          if git rev-parse --verify "refs/tags/$tag" >/dev/null 2>&1; then
            if [[ "${{ inputs.overwrite_tag }}" == "true" ]]; then
              echo "::warning::Overwriting existing tag: $tag"
              git tag -d "$tag"
              git push origin ":refs/tags/$tag" || true
            else
              echo "::error::Tag $tag already exists. Use overwrite_tag option to replace it."
              exit 1
            fi
          fi

      - name: Create and push tag
        run: |
          tag="${{ needs.determine-version.outputs.tag_version }}"
          git tag "$tag"
          git push origin "$tag"
          echo "::notice::Created and pushed tag: $tag"

  build:
    needs: [determine-version, create-tag]
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    continue-on-error: true  # Allow other builds to continue if one fails
    strategy:
      fail-fast: false
      matrix:
        include:
          - { os: ubuntu-latest, target: x86_64-unknown-linux-gnu }
          - { os: windows-latest, target: x86_64-pc-windows-msvc }
          - { os: windows-latest, target: aarch64-pc-windows-msvc }
          - { os: macos-latest, target: x86_64-apple-darwin }
          - { os: macos-latest, target: aarch64-apple-darwin }

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.determine-version.outputs.tag_version }}

      - name: Install system dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Build binary
        run: |
          cargo build --release --target ${{ matrix.target }}

      - name: Prepare binary for upload
        shell: bash
        run: |
          target="${{ matrix.target }}"
          
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            binary_name="ClashVisionRuntime.exe"
            artifact_name="ClashVisionRuntime-${target}.exe"
          else
            binary_name="ClashVisionRuntime"
            artifact_name="ClashVisionRuntime-${target}"
          fi
          
          cp "target/${target}/release/${binary_name}" "${artifact_name}"
          
          echo "ARTIFACT_NAME=${artifact_name}" >> $GITHUB_ENV

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_NAME }}
          if-no-files-found: error
          retention-days: 1

  create-release:
    needs: [determine-version, build]
    runs-on: ubuntu-latest
    if: always() && needs.determine-version.result == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -type f -exec cp {} release-assets/ \;
          ls -la release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.determine-version.outputs.tag_version }}
          name: Release ${{ needs.determine-version.outputs.tag_version }}
          draft: false
          prerelease: false
          files: release-assets/*
          generate_release_notes: true
          fail_on_unmatched_files: false
          token: ${{ secrets.GITHUB_TOKEN }}

  summary:
    needs: [determine-version, build, create-release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Build summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.determine-version.outputs.tag_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Crate Version:** ${{ needs.determine-version.outputs.crate_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Results:" >> $GITHUB_STEP_SUMMARY
          
          # This will show the status of each build job
          echo "| Target | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "| All targets | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Some targets | âš ï¸ Partial success (check individual job results) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.create-release.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **Release created successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.determine-version.outputs.tag_version }})" >> $GITHUB_STEP_SUMMARY
          fi